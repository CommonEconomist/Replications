setwd("~/Dropbox/Glasnost/Replications")
deaths<-read.csv("2013_Hagopian_et_al/raw_data/hh_deaths.csv",header=TRUE,sep=",",row.names=NULL)
deaths<-read.csv("2013_Hagopian_et_al/hh_deaths.csv",header=TRUE,sep=",",row.names=NULL)
households<-read.csv("2013_Hagopian_et_al/hh_roster.csv",header=TRUE,sep=",",row.names=NULL)
population<-read.csv("2013_Hagopian_et_al/pop.csv",header=TRUE,sep=",",row.names=NULL)
deaths<-deaths[deaths$cluster!=47 & deaths$cluster!=73,] # -2 obs
households<-households[households$cluster!=47 & households$cluster!=73,] # - 203 obs.
households[households$cluster==34,]$gov<-13
households[households$cluster==87,]$gov<-6
households[households$cluster==90,]$gov<-2
deaths[deaths$cluster==87,]$gov<-6
deaths[deaths$cluster==90,]$gov<-2
households[households$cluster==21 & households$hh==7,]$gov<-8
households[households$cluster==75 & households$hh==7,]$gov<-9
deaths[deaths$cluster==21 & deaths$hh==7,]$gov<-8
deaths[deaths$cluster==75 & deaths$hh==7,]$gov<-9
sum(is.na(deaths$mod)) # 26 obs.
deaths$mod[is.na(deaths$mod)]<-6
## Recode cardiovascular violent death
#deaths[deaths$cod=="cardiovascular" & deaths$war_death=="Y",]$war_death<-"N"
## Dummy variable for war & normal deaths
# NB: one obs. coded as D (row 100), unsure about meaning.
deaths$col<-as.numeric(deaths$war_death=="Y") # war deaths
deaths$norm<-as.numeric(deaths$war_death=="N") # normal deaths
## Create variable for date
deaths$day<-"01"
deaths$date <- paste(deaths$yod, deaths$mod, deaths$day, sep="-")
deaths$date <- as.Date(deaths$date)
deaths$day<-NULL
# Pre-war deaths (all deaths before 03-2003)
deaths$norm_pre<-as.numeric(deaths$norm==1 &
deaths$date<="2003-02-01") # pre-war
# During-war deaths (all deaths after 03-2003)
# NB: 1 obs. in August 2011
deaths$norm_dum<-as.numeric(deaths$norm==1 &
deaths$date>"2003-02-01") # during war
d.pre<-sum(deaths$norm_pre) # Pre-war (44)
d.during<-sum(deaths$norm_dum) # Normal during war (262)
d.war<-sum(deaths$col) # Fatalities (76)
#**************************************
#### CALCULATE PERSON-YEARS ####
#**************************************
#### Households ####
households$yob<-2011.5-(households$age+0.5)
households$hh_f<-households$year_hh_formed+0.5
## Pre-war period
households$t0<-2001
households$t1<-2003.167
# Account for household formation
households$t0<-apply(households[,c("hh_f","t0")],1,max)
households$t1<-apply(households[,c("hh_f","t1")],1,max)
# Exposure
households$exp0<-households$t1-households$yob
households[households$yob<=households$t0,]$exp0<-
households[households$yob<=households$t0,]$t1-
households[households$yob<=households$t0,]$t0
households[households$yob>households$t1,]$exp0<-0
sum(households$exp0) # 14561.54
## War-period
households$t0<-2003.167
households$t1<-2011.5
# Account for households formation
households$t0<-apply(households[,c("hh_f","t0")],1,max)
households$t1<-apply(households[,c("hh_f","t1")],1,max)
# Exposure
households$exp1<-households$t1-households$yob
households[households$yob<=households$t0,]$exp1<-
households[households$yob<=households$t0,]$t1-
households[households$yob<=households$t0,]$t0
sum(households$exp1) # 73282.96
#### Deaths ####
deaths$yod<-deaths$yod+(deaths$mod-0.5)/12
deaths$hh_f<-deaths$year_hh_formed+.5
## Before war
deaths$t0<-2001
deaths$t1<-2003.167
# Account for household formation
deaths$t0<-apply(deaths[,c("hh_f","t0")],1,max)
deaths$t1<-apply(deaths[,c("hh_f","t1")],1,max)
# Exposure
deaths$exp0<-deaths$t1-deaths$yod
deaths[deaths$yod>deaths$t1,]$exp0<-deaths[deaths$yod>deaths$t1,]$t1-
deaths[deaths$yod>deaths$t1,]$t0
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$exp0<-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$yod-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$t0
sum(deaths$exp0) 654.18
names(deaths)
sum(deaths$exp0) # 654.18
deaths$t0<-2003.167
deaths$t1<-2011.5
# Account for household formation
deaths$t0<-apply(deaths[,c("hh_f","t0")],1,max)
deaths$t1<-apply(deaths[,c("hh_f","t1")],1,max)
# Exposure
deaths$exp1<-deaths$t1-deaths$yod
deaths[deaths$yod<deaths$t0,]$exp1<-0
deaths[deaths$yod>deaths$t1,]$exp1<-deaths[deaths$yod>deaths$t1,]$t1-
deaths[deaths$yod>deaths$t1,]$t0
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$exp1<-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$yod-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$t0
sum(deaths$exp1) # 1227.82
py0<-sum(households$exp0)+sum(deaths$exp0) # Pre-war (15335.32) 15215.72
py1<-sum(households$exp1)+sum(deaths$exp1) # During war (74636.51) 74510.78
cdr0<-1000*d.pre/py0 # Pre-war (2.89 vs. original 2.89)
cdr1<-1000*(d.during+d.war)/py1 # During war (4.54 vs. original 4.55)
excess=cdr1-cdr0 # (1.64)
pop<-aggregate(population~year,population,sum)
py<-sum(pop[8:14,2])+9/12*pop[7,2]+.5*pop[15,2]
excess*py/1000 # 402188
dr<-1000*d.war/py1
dr*py/1000 # 249452
dr<-1000*d.war/py1
dr*py/1000
resample <- function(dat, cluster, replace) {
# exit early for trivial data
if(nrow(dat) == 1 || all(replace==FALSE))
return(dat)
# clustering factor
cft <- dat[[cluster[1]]]
# sample the clustering factor
cls <- sample(unique(cft), replace=replace[1])
# subset on the sampled clustering factors
sub <- lapply(cls, function(b) subset(dat, cft==b))
# sample lower levels of hierarchy (if any)
if(length(cluster) > 1)
sub <- lapply(sub, resample, cluster=cluster[-1], replace=replace[-1])
# join and return samples
do.call(rbind, sub)
}
d<-aggregate(cbind(col,norm_pre,norm_dum,exp0,exp1)~hh+cluster+gov,deaths,FUN=sum)
hh<-aggregate(cbind(exp0,exp1)~hh+cluster+gov,households,FUN=sum)
dat<-merge(hh,d,by=c("hh","cluster","gov"),all.x=TRUE)
dat[is.na(dat)]<-0
dat$exp0<-dat$exp0.x+dat$exp0.y
dat$exp1<-dat$exp1.x+dat$exp1.y
dat$exp0.x<-dat$exp0.y<-dat$exp1.x<-dat$exp1.y<-NULL
cluster<-c("gov","cluster","hh")
set.seed(2014);system.time(v<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$col)))
# pre-war deaths (14m55s)
set.seed(2014);system.time(d0<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$norm_pre)))
# during war deaths (15m)
set.seed(2014);system.time(d1<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$norm_dum)))
## Bootstrap person-years
# pre-war exposure (14m54s)
set.seed(2014);system.time(b.exp0<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$exp0)))
# war exposure (15m5s)
set.seed(2014);system.time(b.exp1<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$exp1)))
probs<-(1+c(-1,1)*0.95)/2 # 95% interval
a<-1000*(d1+v)/b.exp1-1000*d0/b.exp0
boxplot(a)
a<-1000*(d1+v)/b.exp1-1000*d0/b.exp0
b<-a*py/1000
quantile(a,probs=probs) # 0.20; 3.09
quantile(b,probs=probs) # 50124; 756399
a<-1000*d1/b.exp1-1000*d0/b.exp0
b<-a*py/1000
quantile(a,probs=probs) # -0.80; 1.95
quantile(b,probs=probs) # -196019; 478079
sum(a>0)/length(a)*100 # 80.3%
a<-1000*(d1+v)/b.exp1-1000*d0/b.exp0
b<-a*py/1000
boxplot(a)
boxplot(b)
library(PerformanceAnalytics)
library(psych)
chart.Boxplot(b, main = "",
xlab="uncertainty interval", ylab="",
element.color = "transparent", as.Tufte=TRUE)
options(scipen=4)
chart.Boxplot(b, main = "",
xlab="uncertainty interval", ylab="",
element.color = "transparent", as.Tufte=TRUE)
?chart.Boxplot
a<-1000*(d1+v)/b.exp1-1000*d0/b.exp0
b<-a*py/1000
excess.deaths<-b
quantile(a,probs=probs) # 0.20; 3.09
quantile(b,probs=probs) # 50124; 756399
a<-1000*d1/b.exp1-1000*d0/b.exp0
b<-a*py/1000
excess.normal<-b
quantile(a,probs=probs) # -0.80; 1.95
quantile(b,probs=probs) # -196019; 478079
sum(a>0)/length(a)*100 # 80.3%
d<-cbind(excess.deaths,excess.normal)
View(d)
class(d)
d<-data.frame(excess.deaths,excess.normal)
View(d)
colnames(d)<-c("Excess deaths","Excess non-violent deaths")
chart.Boxplot(d, main = "",
xlab="uncertainty interval", ylab="",
element.color = "transparent", as.Tufte=TRUE)
a<-1000*(d1+v)/b.exp1-1000*d0/b.exp0
b<-a*py/1000
excess.deaths<-b
quantile(a,probs=probs) # 0.20; 3.09
quantile(b,probs=probs) # 50124; 756399
a<-1000*d1/b.exp1-1000*d0/b.exp0
b<-a*py/1000
excess.normal<-b
quantile(a,probs=probs) # -0.80; 1.95
quantile(b,probs=probs) # -196019; 478079
sum(a>0)/length(a)*100 # 80.3%
a<-1000*v/b.exp1
b<-a*py/1000
violent.deaths<-b
quantile(a,probs=probs) # 0.20; 3.09
quantile(b,probs=probs) # 50124; 756399
d<-data.frame("Violent deaths"=violent.deaths)
View(d)
d<-data.frame(exc=excess.deaths,norm=excess.normal,v=violent.deaths)
colnames(d)<-c("Excess deaths","Non-violent excess deaths","Violent deaths")
chart.Boxplot(d, main = "Bootstrap estimates (1000)", xlab="", ylab="",
element.color = "transparent", as.Tufte=TRUE)
?boxplot
boxplot(d)
?boxplot
boxplot(d,notch=TRUE,horizontal=TRUE)
?chart.Boxplot
min(d)
max(d)
chart.Boxplot(d, main = "Bootstrap estimates (1000)", xlab="", ylab="",
element.color = "transparent", as.Tufte=TRUE,xlim=c(-500000,1100000))
chart.Boxplot(d, main = "Bootstrap estimates (1000)", xlab="", ylab="",
element.color = "transparent", as.Tufte=TRUE,ylim=c(-500000,1100000))
chart.Boxplot(d, main = "Bootstrap estimates", xlab="", ylab="",
element.color = "transparent", as.Tufte=TRUE,ylim=c(-500000,1100000))
chart.Boxplot(d, main = "Bootstrap estimates", xlab="", ylab="",show.data=3,
element.color = "transparent", as.Tufte=TRUE,ylim=c(-500000,1100000))
chart.Boxplot(d, main = "Bootstrap estimates", xlab="", ylab="",
element.color = "transparent", as.Tufte=TRUE,ylim=c(-500000,1100000))
chart.Boxplot(d, main = "Bootstrap estimates \n (1000 replicates of clusters and households"),
chart.Boxplot(d, main = "Bootstrap estimates \n (1000 replicates of clusters and households)",
xlab="", ylab="",element.color = "transparent", as.Tufte=TRUE,ylim=c(-500000,1100000))
save.image("~/Dropbox/Sandbox/epidemais/output/Replication.RData")
