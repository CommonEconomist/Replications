setwd("~/Dropbox/github/replications/2013_Hagopian_et_al")
deaths<-read.csv("2013_Hagopian_et_al/hh_deaths.csv",header=TRUE,sep=",",row.names=NULL)
list.files()
setwd("~/Dropbox/github/replications")
deaths<-read.csv("2013_Hagopian_et_al/hh_deaths.csv",header=TRUE,sep=",",row.names=NULL)
households<-read.csv("2013_Hagopian_et_al/hh_roster.csv",header=TRUE,sep=",",row.names=NULL)
population<-read.csv("2013_Hagopian_et_al/pop.csv",header=TRUE,sep=",",row.names=NULL)
resample <- function(dat, cluster, replace) {
# exit early for trivial data
if(nrow(dat) == 1 || all(replace==FALSE))
return(dat)
# clustering factor
cft <- dat[[cluster[1]]]
# sample the clustering factor
cls <- sample(unique(cft), replace=replace[1])
# subset on the sampled clustering factors
sub <- lapply(cls, function(b) subset(dat, cft==b))
# sample lower levels of hierarchy (if any)
if(length(cluster) > 1)
sub <- lapply(sub, resample, cluster=cluster[-1], replace=replace[-1])
# join and return samples
do.call(rbind, sub)
}
deaths<-deaths[deaths$cluster!=47 & deaths$cluster!=73,] # -2 obs
households<-households[households$cluster!=47 & households$cluster!=73,] # - 203 obs.
households[households$cluster==34,]$gov<-13
households[households$cluster==87,]$gov<-6
households[households$cluster==90,]$gov<-2
deaths[deaths$cluster==87,]$gov<-6
deaths[deaths$cluster==90,]$gov<-2
households[households$cluster==21 & households$hh==7,]$gov<-8
households[households$cluster==75 & households$hh==7,]$gov<-9
deaths[deaths$cluster==21 & deaths$hh==7,]$gov<-8
deaths[deaths$cluster==75 & deaths$hh==7,]$gov<-9
sum(is.na(deaths$mod)) # 26 obs.
deaths$mod[is.na(deaths$mod)]<-6
deaths$col<-as.numeric(deaths$war_death=="Y") # war deaths
deaths$norm<-as.numeric(deaths$war_death=="N") # normal deaths
deaths$day<-"01"
deaths$date <- paste(deaths$yod, deaths$mod, deaths$day, sep="-")
deaths$date <- as.Date(deaths$date)
deaths$day<-NULL
deaths$norm_pre<-as.numeric(deaths$norm==1 &
deaths$date<="2003-02-01") # pre-war
deaths$norm_dum<-as.numeric(deaths$norm==1 &
deaths$date>"2003-02-01") # during war
d.pre<-sum(deaths$norm_pre) # Pre-war (44)
d.during<-sum(deaths$norm_dum) # Normal during war (262)
d.war<-sum(deaths$col) # Fatalities (76)
households$yob<-2011.5-(households$age+0.5)
households$hh_f<-households$year_hh_formed+0.5
households$t0<-2001
households$t1<-2003.167
households$t0<-apply(households[,c("hh_f","t0")],1,max)
households$t1<-apply(households[,c("hh_f","t1")],1,max)
households$exp0<-households$t1-households$yob
households[households$yob<=households$t0,]$exp0<-
households[households$yob<=households$t0,]$t1-
households[households$yob<=households$t0,]$t0
households[households$yob>households$t1,]$exp0<-0
sum(households$exp0) # 14561.54
households$t0<-2003.167
households$t1<-2011.5
households$t0<-apply(households[,c("hh_f","t0")],1,max)
households$t1<-apply(households[,c("hh_f","t1")],1,max)
households$exp1<-households$t1-households$yob
households[households$yob<=households$t0,]$exp1<-
households[households$yob<=households$t0,]$t1-
households[households$yob<=households$t0,]$t0
sum(households$exp1) # 73282.96
deaths$yod<-deaths$yod+(deaths$mod-0.5)/12
deaths$hh_f<-deaths$year_hh_formed+.5
deaths$t0<-2001
deaths$t1<-2003.167
deaths$t0<-apply(deaths[,c("hh_f","t0")],1,max)
deaths$t1<-apply(deaths[,c("hh_f","t1")],1,max)
deaths$exp0<-deaths$t1-deaths$yod
deaths[deaths$yod>deaths$t1,]$exp0<-deaths[deaths$yod>deaths$t1,]$t1-
deaths[deaths$yod>deaths$t1,]$t0
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$exp0<-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$yod-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$t0
sum(deaths$exp0) # 654.18
deaths$t0<-2003.167
deaths$t1<-2011.5
deaths$t0<-apply(deaths[,c("hh_f","t0")],1,max)
deaths$t1<-apply(deaths[,c("hh_f","t1")],1,max)
deaths$exp1<-deaths$t1-deaths$yod
deaths[deaths$yod<deaths$t0,]$exp1<-0
deaths[deaths$yod>deaths$t1,]$exp1<-deaths[deaths$yod>deaths$t1,]$t1-
deaths[deaths$yod>deaths$t1,]$t0
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$exp1<-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$yod-
deaths[deaths$yod>=deaths$t0 & deaths$yod<=deaths$t1,]$t0
sum(deaths$exp1) # 1227.82
py0<-sum(households$exp0)+sum(deaths$exp0) # Pre-war: 15215.72
py1<-sum(households$exp1)+sum(deaths$exp1) # During war: 74510.78
cdr0<-1000*d.pre/py0 # Pre-war: 2.89  (Original 2.89)
cdr1<-1000*(d.during+d.war)/py1 # During war: 4.54 (Original 4.55)
excess=cdr1-cdr0 # 1.64
pop<-aggregate(population~year,population,sum)
py<-sum(pop[8:14,2])+9/12*pop[7,2]+.5*pop[15,2]
excess*py/1000
dr<-1000*d.war/py1
dr*py/1000
d<-aggregate(cbind(col,norm_pre,norm_dum,exp0,exp1)~hh+cluster+gov,deaths,FUN=sum)
hh<-aggregate(cbind(exp0,exp1)~hh+cluster+gov,households,FUN=sum)
dat<-merge(hh,d,by=c("hh","cluster","gov"),all.x=TRUE)
dat[is.na(dat)]<-0
dat$exp0<-dat$exp0.x+dat$exp0.y
dat$exp1<-dat$exp1.x+dat$exp1.y
dat$exp0.x<-dat$exp0.y<-dat$exp1.x<-dat$exp1.y<-NULL
cluster<-c("gov","cluster","hh")
set.seed(2014);system.time(v<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$col)))
set.seed(2014);system.time(d0<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$norm_pre)))
set.seed(2014);system.time(d1<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$norm_dum)))
set.seed(2014);system.time(b.exp0<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$exp0)))
set.seed(2014);system.time(b.exp1<-replicate(1000,sum(resample(dat,cluster,c(F,T,T))$exp1)))
probs<-(1+c(-1,1)*0.95)/2 # 95% interval
a<-1000*(d1+v)/b.exp1-1000*d0/b.exp0
b<-a*py/1000
excess.deaths<-b
quantile(a,probs=probs) # 0.20; 3.09
quantile(b,probs=probs) # 50124; 756399
b
summary(b)
hist(b)
boxplot(b)
